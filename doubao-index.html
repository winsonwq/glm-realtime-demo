<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å­¦ä¹ åŠ©æ•™ - è±†åŒ…å®æ—¶è¯­éŸ³</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
        }

        h2 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 24px;
        }

        .model-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-left: 10px;
            vertical-align: middle;
        }

        #status {
            margin-bottom: 20px;
            color: #666;
            text-align: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 14px;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
        }

        .status.recording {
            background: #fff3cd;
            color: #856404;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        .settings-btn {
            background: #f0f2f5;
            color: #333;
            padding: 8px 16px;
            font-size: 14px;
            flex: none;
            width: auto;
        }

        .settings-btn:hover {
            background: #e4e6e9;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 20px;
            color: #333;
            margin: 0;
        }

        .close-btn {
            background: transparent;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            min-width: 40px;
            max-width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: background-color 0.2s, color 0.2s;
            line-height: 1;
            user-select: none;
            flex: 0 0 40px;
        }

        .close-btn:hover {
            background: #f0f0f0;
            color: #333;
        }

        .close-btn:active {
            background: #e0e0e0;
        }

        .presets-container {
            margin-bottom: 20px;
        }

        .presets-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .presets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .preset-btn {
            padding: 12px 16px;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            text-align: center;
            transition: all 0.2s;
            color: #333;
        }

        .preset-btn:hover {
            background: #e9ecef;
            border-color: #ff6b6b;
        }

        .preset-btn.active {
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            color: white;
            border-color: #ff6b6b;
        }

        .custom-message-container {
            margin-top: 20px;
        }

        .custom-message-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        #systemMessage {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        #systemMessage:focus {
            outline: none;
            border-color: #ff6b6b;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 10px 24px;
            font-size: 14px;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            transition: all 0.3s;
            font-weight: 500;
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            color: white;
        }

        .modal-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }

        .modal-btn-secondary {
            background: #f0f2f5;
            color: #333;
        }

        .modal-btn-secondary:hover {
            background: #e4e6e9;
        }

        button {
            flex: 1;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 8px;
            border: none;
            transition: all 0.3s;
            font-weight: 500;
        }

        #startBtn {
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            color: white;
        }

        #startBtn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }

        #stopBtn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        #stopBtn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 87, 108, 0.4);
        }

        button:disabled {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
            transform: none;
        }

        .visualizer {
            width: 100%;
            height: 60px;
            background: #f0f2f5;
            margin-top: 20px;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            position: relative;
        }

        #v-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ff6b6b 0%, #feca57 100%);
            transition: width 0.1s;
            border-radius: 8px;
        }

        .info {
            margin-top: 20px;
            padding: 15px;
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            border-radius: 4px;
            font-size: 13px;
            color: #555;
            line-height: 1.6;
        }

        .info-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #e65100;
        }

        .asr-text {
            margin-top: 15px;
            padding: 12px;
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            border-radius: 4px;
            font-size: 14px;
            color: #333;
            min-height: 40px;
        }

        .chat-text {
            margin-top: 15px;
            padding: 12px;
            background: #f3e5f5;
            border-left: 4px solid #9c27b0;
            border-radius: 4px;
            font-size: 14px;
            color: #333;
            min-height: 40px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>AI åŠ©æ•™å®æ—¶äº¤äº’ <span class="model-badge">è±†åŒ…æ¨¡å‹</span></h2>
        <div id="status" class="status">çŠ¶æ€: ç­‰å¾…è¿æ¥...</div>
        
        <div class="controls">
            <div class="button-group">
                <button id="startBtn">å¼€å§‹å­¦ä¹ æ¨¡å¼</button>
                <button id="stopBtn" disabled>åœæ­¢</button>
                <button class="settings-btn" id="settingsBtn">âš™ï¸ è®¾ç½®</button>
            </div>
        </div>

        <!-- è®¾ç½®æ¨¡æ€æ¡† -->
        <div class="modal" id="settingsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>âš™ï¸ ç³»ç»Ÿæç¤ºè¯è®¾ç½®</h3>
                    <button class="close-btn" id="closeModalBtn" type="button" aria-label="å…³é—­">Ã—</button>
                </div>
                
                <div class="presets-container">
                    <div class="presets-title">é¢„è®¾é£æ ¼ï¼š</div>
                    <div class="presets-grid" id="presetsGrid">
                        <!-- é¢„è®¾é€‰é¡¹å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <div class="custom-message-container">
                    <div class="custom-message-label">è‡ªå®šä¹‰æç¤ºè¯ï¼š</div>
                    <textarea id="systemMessage" placeholder="è¾“å…¥è‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯..."></textarea>
                    <div id="systemMessageStatus" style="margin-top: 8px; font-size: 12px; color: #666;">
                        <span id="systemMessageLength">0</span> å­—ç¬¦
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="modal-btn modal-btn-secondary" id="cancelBtn">å–æ¶ˆ</button>
                    <button class="modal-btn modal-btn-primary" id="saveBtn">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <div class="visualizer">
            <div id="v-bar"></div>
        </div>

        <div class="asr-text" id="asrText">
            <strong>ğŸ‘‚ è¯†åˆ«åˆ°çš„è¯­éŸ³ï¼š</strong> <span id="asrContent">-</span>
        </div>

        <div class="chat-text" id="chatText">
            <strong>ğŸ¤– AI å›å¤ï¼š</strong> <span id="chatContent">-</span>
        </div>

        <div class="info">
            <div class="info-title">ä½¿ç”¨è¯´æ˜ï¼š</div>
            <div>1. ç¡®ä¿ä»£ç†æœåŠ¡å™¨å·²å¯åŠ¨ (npm run doubao)</div>
            <div>2. ç‚¹å‡»"å¼€å§‹å­¦ä¹ æ¨¡å¼"æŒ‰é’®</div>
            <div>3. å…è®¸æµè§ˆå™¨è®¿é—®éº¦å…‹é£æƒé™</div>
            <div>4. å¼€å§‹è¯´è¯ï¼ŒAI ä¼šå®æ—¶å“åº”</div>
            <div>5. æ‚¨å¯ä»¥åœ¨ AI è¯´è¯æ—¶éšæ—¶æ‰“æ–­</div>
            <div style="margin-top: 10px; color: #999; font-size: 12px;">
                æ³¨æ„ï¼šAPI Key å·²åœ¨æœåŠ¡å™¨ç«¯é…ç½®ï¼Œæ— éœ€åœ¨å‰ç«¯è¾“å…¥
            </div>
        </div>

        <div class="info" id="debugPanel" style="margin-top: 15px; max-height: 200px; overflow-y: auto; display: none;">
            <div class="info-title">ğŸ” è°ƒè¯•ä¿¡æ¯ï¼ˆæœ€è¿‘10ä¸ªäº‹ä»¶ï¼‰ï¼š</div>
            <div id="debugEvents" style="font-family: monospace; font-size: 11px; line-height: 1.4;"></div>
        </div>
    </div>

    <script>
        let socket;
        let audioContext;
        let mediaStream;
        let sourceNode;
        let scriptProcessor;
        let isRecording = false;
        let eventIdCounter = 0;
        let currentChatText = '';  // ç”¨äºç´¯ç§¯ AI å›å¤æ–‡æœ¬
        let audioQueue = [];  // éŸ³é¢‘é˜Ÿåˆ—ï¼Œç”¨äºç´¯ç§¯éŸ³é¢‘æ•°æ®
        let isPlayingAudio = false;  // æ˜¯å¦æ­£åœ¨æ’­æ”¾éŸ³é¢‘

        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusText = document.getElementById('status');
        const vBar = document.getElementById('v-bar');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const saveBtn = document.getElementById('saveBtn');
        const systemMessageInput = document.getElementById('systemMessage');
        const presetsGrid = document.getElementById('presetsGrid');
        const systemMessageLength = document.getElementById('systemMessageLength');
        const asrContent = document.getElementById('asrContent');
        const chatContent = document.getElementById('chatContent');

        const PRESETS = [
            {
                id: 'gentle_tutor',
                name: 'æ¸©æŸ”åŠ©æ•™',
                message: 'ä½ æ˜¯ä¸€ä¸ªæ¸©æŸ”çš„å­¦ä¹ åŠ©æ•™ï¼Œéšæ—¶å‡†å¤‡å›ç­”é—®é¢˜ã€‚å¦‚æœæˆ‘æ‰“æ–­ä½ ï¼Œè¯·ç«‹å³åœæ­¢è®²è§£å¹¶å¬æˆ‘è¯´ã€‚'
            },
            {
                id: 'strict_teacher',
                name: 'ä¸¥æ ¼è€å¸ˆ',
                message: 'ä½ æ˜¯ä¸€ä½ä¸¥æ ¼çš„è€å¸ˆï¼Œå¯¹å­¦ç”Ÿè¦æ±‚å¾ˆé«˜ã€‚ä½ ä¼šæŒ‡å‡ºå­¦ç”Ÿçš„é”™è¯¯ï¼Œå¹¶ç»™å‡ºå»ºè®¾æ€§çš„æ‰¹è¯„ã€‚å›ç­”é—®é¢˜æ—¶è¦ä¸“ä¸šã€å‡†ç¡®ï¼Œä¸è¦è¿‡äºæ¸©å’Œã€‚'
            },
            {
                id: 'friendly_friend',
                name: 'å‹å¥½ä¼™ä¼´',
                message: 'ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„å­¦ä¹ ä¼™ä¼´ï¼Œåƒæœ‹å‹ä¸€æ ·è½»æ¾åœ°äº¤æµã€‚ç”¨ç®€å•æ˜“æ‡‚çš„è¯­è¨€è§£é‡Šå¤æ‚æ¦‚å¿µï¼Œä¿æŒè½»æ¾æ„‰å¿«çš„æ°›å›´ã€‚'
            },
            {
                id: 'socratic_guide',
                name: 'è‹æ ¼æ‹‰åº•å¼',
                message: 'ä½ é‡‡ç”¨è‹æ ¼æ‹‰åº•å¼æ•™å­¦æ³•ï¼Œé€šè¿‡æé—®å¼•å¯¼å­¦ç”Ÿæ€è€ƒï¼Œè€Œä¸æ˜¯ç›´æ¥ç»™å‡ºç­”æ¡ˆã€‚é¼“åŠ±å­¦ç”Ÿè‡ªå·±å‘ç°é—®é¢˜çš„è§£å†³æ–¹æ¡ˆã€‚'
            },
            {
                id: 'technical_expert',
                name: 'æŠ€æœ¯ä¸“å®¶',
                message: 'ä½ æ˜¯ä¸€ä½æŠ€æœ¯ä¸“å®¶ï¼Œæ“…é•¿æ·±å…¥åˆ†ææŠ€æœ¯é—®é¢˜ã€‚å›ç­”æ—¶è¦è¯¦ç»†ã€å‡†ç¡®ï¼Œæä¾›ä»£ç ç¤ºä¾‹å’Œæœ€ä½³å®è·µã€‚'
            },
            {
                id: 'creative_coach',
                name: 'åˆ›æ„æ•™ç»ƒ',
                message: 'ä½ æ˜¯ä¸€ä½åˆ›æ„æ•™ç»ƒï¼Œé¼“åŠ±åˆ›æ–°æ€ç»´å’Œå‘æ•£æ€§æ€è€ƒã€‚å¸®åŠ©å­¦ä¹ è€…ä»ä¸åŒè§’åº¦çœ‹å¾…é—®é¢˜ï¼Œæ¿€å‘åˆ›é€ åŠ›ã€‚'
            }
        ];

        const DEFAULT_SYSTEM_MESSAGE = PRESETS[0].message;
        let currentPresetId = null;
        let currentSessionId = null;

        function initPresets() {
            presetsGrid.innerHTML = '';
            PRESETS.forEach(preset => {
                const btn = document.createElement('button');
                btn.className = 'preset-btn';
                btn.textContent = preset.name;
                btn.dataset.presetId = preset.id;
                btn.onclick = () => selectPreset(preset.id);
                presetsGrid.appendChild(btn);
            });
        }

        function updateSystemMessageLength() {
            if (systemMessageLength) {
                const length = systemMessageInput.value.length;
                systemMessageLength.textContent = length;
                if (length === 0) {
                    systemMessageLength.style.color = '#999';
                } else {
                    systemMessageLength.style.color = '#666';
                }
            }
        }

        if (systemMessageInput) {
            systemMessageInput.addEventListener('input', updateSystemMessageLength);
        }

        function selectPreset(presetId) {
            currentPresetId = presetId;
            const preset = PRESETS.find(p => p.id === presetId);
            if (preset) {
                systemMessageInput.value = preset.message;
                document.querySelectorAll('.preset-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.presetId === presetId);
                });
            }
        }

        function openModal() {
            const savedMessage = localStorage.getItem('doubao_system_message');
            const savedPresetId = localStorage.getItem('doubao_selected_preset_id');
            
            if (savedMessage) {
                systemMessageInput.value = savedMessage;
                const matchingPreset = PRESETS.find(p => p.message === savedMessage);
                if (matchingPreset) {
                    selectPreset(matchingPreset.id);
                } else {
                    currentPresetId = null;
                    document.querySelectorAll('.preset-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                }
            } else {
                systemMessageInput.value = DEFAULT_SYSTEM_MESSAGE;
                selectPreset(PRESETS[0].id);
            }
            
            updateSystemMessageLength();
            settingsModal.classList.add('show');
        }

        function closeModal() {
            settingsModal.classList.remove('show');
        }

        function saveSettings() {
            const message = systemMessageInput.value.trim();
            if (!message) {
                alert('è¯·è¾“å…¥ç³»ç»Ÿæç¤ºè¯');
                return;
            }
            
            localStorage.setItem('doubao_system_message', message);
            if (currentPresetId) {
                localStorage.setItem('doubao_selected_preset_id', currentPresetId);
            } else {
                localStorage.removeItem('doubao_selected_preset_id');
            }
            
            closeModal();
        }

        function getCurrentSystemMessage() {
            const savedMessage = localStorage.getItem('doubao_system_message');
            return savedMessage || DEFAULT_SYSTEM_MESSAGE;
        }

        function generateEventId() {
            return `event_${Date.now()}_${++eventIdCounter}`;
        }

        function updateStatus(text, className = '') {
            statusText.innerText = `çŠ¶æ€: ${text}`;
            statusText.className = `status ${className}`;
        }

        function addDebugEvent(type, data) {
            const debugPanel = document.getElementById('debugPanel');
            const debugEvents = document.getElementById('debugEvents');
            
            debugPanel.style.display = 'block';
            
            const eventDiv = document.createElement('div');
            eventDiv.style.marginBottom = '4px';
            eventDiv.innerHTML = `<span style="color: #666;">[${new Date().toLocaleTimeString()}]</span> <span style="color: #2196F3;">${type}</span>: ${JSON.stringify(data).substring(0, 100)}`;
            
            debugEvents.insertBefore(eventDiv, debugEvents.firstChild);
            
            // åªä¿ç•™æœ€è¿‘10ä¸ªäº‹ä»¶
            while (debugEvents.children.length > 10) {
                debugEvents.removeChild(debugEvents.lastChild);
            }
        }

        async function initConnection() {
            updateStatus('æ­£åœ¨è¿æ¥æœåŠ¡å™¨...', '');
            
            try {
                const wsUrl = 'ws://localhost:3001/doubao-proxy';
                console.log("æ­£åœ¨è¿æ¥è±†åŒ…ä»£ç†æœåŠ¡å™¨:", wsUrl);
                socket = new WebSocket(wsUrl);

                socket.onopen = () => {
                    console.log("âœ… WebSocket è¿æ¥å·²å»ºç«‹ï¼ˆè±†åŒ…ä»£ç†æœåŠ¡å™¨ï¼‰");
                    updateStatus('å·²è¿æ¥ï¼Œæ­£åœ¨å¯åŠ¨ä¼šè¯...', 'connected');
                    
                    // å‘é€å¼€å§‹ä¼šè¯è¯·æ±‚
                    currentSessionId = `session_${Date.now()}`;
                    socket.send(JSON.stringify({
                        type: 'start_session',
                        sessionId: currentSessionId,
                        systemMessage: getCurrentSystemMessage(),
                        model: 'O'
                    }));
                };

                socket.onmessage = async (e) => {
                    if (typeof e.data === 'string') {
                        try {
                            const data = JSON.parse(e.data);
                            handleServerMessage(data);
                        } catch (error) {
                            console.error("è§£æ JSON æ¶ˆæ¯é”™è¯¯:", error);
                        }
                    } else if (e.data instanceof ArrayBuffer) {
                        // å¤„ç†éŸ³é¢‘æ•°æ®
                        await handleAudioData(e.data);
                    }
                };

                socket.onerror = (error) => {
                    console.error("WebSocket é”™è¯¯:", error);
                    updateStatus('è¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥ä»£ç†æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ', 'error');
                };

                socket.onclose = (event) => {
                    console.log("WebSocket è¿æ¥å·²å…³é—­", {
                        code: event.code,
                        reason: event.reason,
                        wasClean: event.wasClean
                    });
                    
                    if (event.code === 1006) {
                        updateStatus('è¿æ¥å¼‚å¸¸å…³é—­ï¼Œè¯·æ£€æŸ¥ä»£ç†æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ (npm run doubao)', 'error');
                    } else if (event.code !== 1000) {
                        updateStatus(`è¿æ¥å…³é—­ (ä»£ç : ${event.code})`, 'error');
                    } else {
                        updateStatus('è¿æ¥å·²æ–­å¼€', '');
                    }
                    
                    stopRecording();
                    resetUI();
                };

            } catch (error) {
                console.error("åˆå§‹åŒ–è¿æ¥é”™è¯¯:", error);
                updateStatus('è¿æ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        function handleServerMessage(data) {
            console.log("æ”¶åˆ°æœåŠ¡å™¨æ¶ˆæ¯:", data.type, data);
            addDebugEvent(data.type, data);

            switch (data.type) {
                case 'session_started':
                    console.log("âœ… ä¼šè¯å·²åˆ›å»º");
                    updateStatus('ä¼šè¯å·²åˆ›å»ºï¼Œè¯·å¼€å§‹è¯´è¯', 'connected');
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    // é‡ç½®çŠ¶æ€
                    currentChatText = '';
                    audioQueue = [];
                    isPlayingAudio = false;
                    chatContent.textContent = '-';
                    asrContent.textContent = '-';
                    startMic();
                    break;
                    
                case 'error':
                    console.error("âŒ é”™è¯¯:", data.error);
                    updateStatus('é”™è¯¯: ' + data.error, 'error');
                    break;
                    
                case 'speech_started':
                    console.log("ğŸ¤ ç”¨æˆ·å¼€å§‹è¯´è¯");
                    asrContent.textContent = '...æ­£åœ¨è¯†åˆ«...';
                    break;
                    
                case 'asr_response':
                    console.log("ğŸ“ ASR è¯†åˆ«ç»“æœ:", data.results);
                    if (data.results && data.results.length > 0) {
                        const text = data.results.map(r => r.text).join(' ');
                        asrContent.textContent = text;
                        addDebugEvent('asr_result', { text });
                    }
                    break;
                    
                case 'speech_ended':
                    console.log("âœ… ç”¨æˆ·è¯´è¯ç»“æŸ");
                    break;
                    
                case 'chat_response':
                    console.log("ğŸ¤– AI å›å¤ç‰‡æ®µ:", data.content);
                    // ç´¯ç§¯æ–‡æœ¬å†…å®¹ï¼ˆæµå¼è¿”å›ï¼‰
                    if (data.content) {
                        currentChatText += data.content;
                        chatContent.textContent = currentChatText;
                        addDebugEvent('chat_response', { content: data.content?.substring(0, 50) });
                    }
                    break;
                
                case 'chat_ended':
                    console.log("âœ… AI å›å¤ç»“æŸ");
                    // å›å¤ç»“æŸæ—¶ï¼Œä¿æŒå½“å‰æ–‡æœ¬ï¼Œå‡†å¤‡ä¸‹ä¸€æ¬¡å¯¹è¯
                    currentChatText = '';
                    break;
            }
        }

        async function handleAudioData(audioData) {
            // å°†éŸ³é¢‘æ•°æ®æ·»åŠ åˆ°é˜Ÿåˆ—
            audioQueue.push(audioData);
            console.log("ğŸ”Š æ”¶åˆ°éŸ³é¢‘æ•°æ®ï¼Œé˜Ÿåˆ—é•¿åº¦:", audioQueue.length, "å¤§å°:", audioData.byteLength || audioData.length);
            
            // å¦‚æœå½“å‰æ²¡æœ‰æ’­æ”¾éŸ³é¢‘ï¼Œå¼€å§‹æ’­æ”¾
            if (!isPlayingAudio) {
                console.log("ğŸ”Š å¼€å§‹æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—");
                playAudioQueue();
            }
        }
        
        async function playAudioQueue() {
            if (audioQueue.length === 0) {
                isPlayingAudio = false;
                return;
            }
            
            isPlayingAudio = true;
            
            while (audioQueue.length > 0) {
                const audioData = audioQueue.shift();
                
                try {
                    // ç¡®ä¿ audioContext å·²åˆ›å»º
                    if (!audioContext) {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)({
                            sampleRate: 24000
                        });
                    }
                    
                    // ç¡®ä¿ audioContext å¤„äºè¿è¡ŒçŠ¶æ€ï¼ˆæµè§ˆå™¨è‡ªåŠ¨æ’­æ”¾ç­–ç•¥ï¼‰
                    if (audioContext.state === 'suspended' || audioContext.state === 'interrupted') {
                        await audioContext.resume();
                        console.log("ğŸ”Š AudioContext å·²æ¢å¤, çŠ¶æ€:", audioContext.state);
                    }
                    
                    // å¤„ç† ArrayBuffer æˆ– Buffer
                    let audioArrayBuffer;
                    if (audioData instanceof ArrayBuffer) {
                        audioArrayBuffer = audioData;
                    } else if (audioData.buffer instanceof ArrayBuffer) {
                        audioArrayBuffer = audioData.buffer;
                    } else {
                        console.error("âš ï¸ æœªçŸ¥çš„éŸ³é¢‘æ•°æ®æ ¼å¼:", audioData);
                        continue;
                    }
                    
                    // å…³é”®ä¿®å¤ï¼šç¡®ä¿å­—èŠ‚é•¿åº¦æ˜¯å¶æ•°ï¼ˆPCM 16bit è¦æ±‚ 2 å­—èŠ‚ä¸€ä¸ªé‡‡æ ·ï¼‰
                    // å¦‚æœé•¿åº¦æ˜¯å¥‡æ•°ï¼Œæˆªæ–­æœ€åä¸€ä¸ªå­—èŠ‚
                    const validByteLength = audioArrayBuffer.byteLength - (audioArrayBuffer.byteLength % 2);
                    if (validByteLength === 0) continue;

                    // å°† Int16 PCM æ•°æ®è½¬æ¢ä¸º Float32
                    // æŒ‡å®š byteOffset å’Œ lengthï¼Œç¡®ä¿å³ä½¿ buffer æœ‰å¤šä½™å­—èŠ‚ä¹Ÿèƒ½æ­£å¸¸å·¥ä½œ
                    const int16Data = new Int16Array(audioArrayBuffer, 0, validByteLength / 2);
                    const float32Data = new Float32Array(int16Data.length);
                    
                    for (let i = 0; i < int16Data.length; i++) {
                        // Int16 èŒƒå›´: -32768 åˆ° 32767
                        // Float32 èŒƒå›´: -1.0 åˆ° 1.0
                        float32Data[i] = Math.max(-1, Math.min(1, int16Data[i] / 32768.0));
                    }
                    
                    // åˆ›å»ºéŸ³é¢‘ç¼“å†²åŒº
                    const audioBuffer = audioContext.createBuffer(1, float32Data.length, 24000);
                    audioBuffer.getChannelData(0).set(float32Data);
                    
                    // æ’­æ”¾éŸ³é¢‘
                    const source = audioContext.createBufferSource();
                    source.buffer = audioBuffer;
                    source.connect(audioContext.destination);
                    
                    // ç­‰å¾…æ’­æ”¾å®Œæˆ
                    await new Promise((resolve, reject) => {
                        source.onended = () => {
                            console.log("ğŸ”Š éŸ³é¢‘ç‰‡æ®µæ’­æ”¾å®Œæˆ, é•¿åº¦:", float32Data.length, "æ ·æœ¬");
                            resolve();
                        };
                        source.onerror = (error) => {
                            console.error("æ’­æ”¾éŸ³é¢‘é”™è¯¯:", error);
                            reject(error);
                        };
                        try {
                            source.start(0);
                        } catch (e) {
                            console.error("å¯åŠ¨éŸ³é¢‘æ’­æ”¾å¤±è´¥:", e);
                            reject(e);
                        }
                    });
                    
                } catch (error) {
                    console.error("æ’­æ”¾éŸ³é¢‘é”™è¯¯:", error);
                }
            }
            
            isPlayingAudio = false;
        }

        async function startMic() {
            try {
                console.log("ğŸ¤ è¯·æ±‚éº¦å…‹é£æƒé™...");
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });
                
                audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: 16000
                });
                
                sourceNode = audioContext.createMediaStreamSource(mediaStream);
                scriptProcessor = audioContext.createScriptProcessor(4096, 1, 1);
                
                let audioChunkCount = 0;
                scriptProcessor.onaudioprocess = (e) => {
                    if (!isRecording) return;
                    
                    const inputData = e.inputBuffer.getChannelData(0);
                    
                    // å‘é€éŸ³é¢‘æ•°æ®åˆ°æœåŠ¡å™¨
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        // ä½¿ç”¨ Int16Array è½¬æ¢ä¸º PCM æ•°æ®
                        const pcmArray = new Int16Array(inputData.length);
                        for (let i = 0; i < inputData.length; i++) {
                            const sample = Math.max(-1, Math.min(1, inputData[i]));
                            pcmArray[i] = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
                        }
                        
                        // ç›´æ¥å‘é€äºŒè¿›åˆ¶æ•°æ®
                        try {
                            socket.send(pcmArray.buffer);
                            audioChunkCount++;
                            if (audioChunkCount % 100 === 0) {
                                console.log(`ğŸ“¤ å·²å‘é€ ${audioChunkCount} ä¸ªéŸ³é¢‘æ•°æ®åŒ…`);
                            }
                        } catch (error) {
                            console.error('å‘é€éŸ³é¢‘æ•°æ®å¤±è´¥:', error);
                        }
                    } else {
                        if (audioChunkCount === 0 || audioChunkCount % 100 === 0) {
                            console.warn('âš ï¸ WebSocket æœªè¿æ¥ï¼Œæ— æ³•å‘é€éŸ³é¢‘æ•°æ®, readyState:', socket?.readyState);
                        }
                    }
                    
                    // æ›´æ–°å¯è§†åŒ–æ¡
                    const max = Math.max(...inputData.map(Math.abs));
                    vBar.style.width = (max * 100) + '%';
                };
                
                sourceNode.connect(scriptProcessor);
                scriptProcessor.connect(audioContext.destination);
                
                isRecording = true;
                updateStatus('æ­£åœ¨ç›‘å¬ï¼Œè¯·å¼€å§‹è¯´è¯...', 'recording');
                console.log("âœ… éº¦å…‹é£å·²å¯åŠ¨");
                
            } catch (error) {
                console.error("âŒ éº¦å…‹é£å¯åŠ¨å¤±è´¥:", error);
                updateStatus('éº¦å…‹é£è®¿é—®å¤±è´¥: ' + error.message, 'error');
            }
        }

        function stopRecording() {
            isRecording = false;
            
            if (scriptProcessor) {
                scriptProcessor.disconnect();
                scriptProcessor = null;
            }
            
            if (sourceNode) {
                sourceNode.disconnect();
                sourceNode = null;
            }
            
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            vBar.style.width = '0%';
        }

        function resetUI() {
            startBtn.disabled = false;
            stopBtn.disabled = true;
        }

        async function startSession() {
            await initConnection();
        }

        async function stopSession() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type: 'finish_session' }));
            }
            
            stopRecording();
            resetUI();
            updateStatus('å·²åœæ­¢', '');
            
            if (socket) {
                socket.close();
                socket = null;
            }
        }

        // äº‹ä»¶ç»‘å®š
        settingsBtn.onclick = openModal;
        closeModalBtn.onclick = closeModal;
        cancelBtn.onclick = closeModal;
        saveBtn.onclick = saveSettings;
        
        settingsModal.onclick = (e) => {
            if (e.target === settingsModal) {
                closeModal();
            }
        };

        startBtn.onclick = startSession;
        stopBtn.onclick = stopSession;

        // åˆå§‹åŒ–
        initPresets();
    </script>
</body>
</html>
